<?php

namespace App\Http\Controllers;

use App\Demandeur;
use App\Exploitation;
use App\Materiel;
use Illuminate\Http\Request;
use MercurySeries\Flashy\Flashy;

class ExploitationController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index()
    {
        dd('liste toutes les exploitations de tous les matériels');
    }

    public function indexMat(Request $request)
    {
        $materiel = new Materiel();
        $exp = new Exploitation();
       // $dd = new Demandeur();// pour trsmettre un objet de type demandeur pour retrver les noms des dd

        //récupération du matos sélectionné
        $select_mat = $request->select_mat;

        //récupération des infos du matos
        $materiel = $materiel->where('numImmat',$select_mat)
            ->orWhere('codeProduit',$select_mat)
            ->first();

        $idMat = $materiel->id;

       //recupération des exploitations du matos
       $listExp = $exp->where('materiel_id',$idMat)->orderBy('date_exploit','desc')->get();

        $maxReleve = $listExp->max('releve_tableau');

        return view('pagesGermac.Exploitation.listeExpMat',compact('listExp','select_mat','idMat','materiel'));
       // dd('liste exploitation d\'un  matos',$selectedMat,$materiel,$idmat,$listExp);
    }


    public function selectMat($action)
    {
        $materiel = new Materiel();
        $materiels1 = $materiel->where('idgrpe',1)->get();
        $materiels2 = $materiel->where('idgrpe',2)->get();
        $materiels3 = $materiel->where('idgrpe',3)->get();
        return view('pagesGermac.Exploitation.selectMat',compact('materiels1','materiels2','materiels3','action'));
    }
    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create(Request $request)
    {
        $dd = new Demandeur();
        $materiel = new Materiel();
        $listdd = $dd->all();
        $imMat = $request->select_mat;
        //récupération des infos du matos
        $materiel = $materiel->where('numImmat',$imMat)
            ->orWhere('codeProduit',$imMat)
            ->first();
        $idMat = $materiel->id;
        return view('pagesGermac.Exploitation.createExp',compact('imMat','listdd','idMat'));
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request)
    {
        $mat = new Materiel();
        $dd = new Demandeur();
        Exploitation::create([
            'motif_exploit' => $request->motif_exploit,
            'date_exploit' => $request->date_exploit,
            'qtite_ravitaillement' => $request->qtite_ravitaillement,
            'releve_tableau' => $request->releve_tableau,
            'demandeur_id' => $request->select_dd,
            'materiel_id' => $request->idMat
        ]);

        //phase de maj de la val km ou horo du matériel concerné
        $materiel = $mat->where('id',$request->idMat)->first();
        if ($materiel->idgrpe == 1 and  $request->releve_tableau > $mat->kilometrage ){
            $materiel->kilometrage = $request->releve_tableau;
        }elseif($materiel->idgrpe == 2 and $request->releve_tableau > $mat->horometre)
            $materiel->horometre = $request->releve_tableau;
        $materiel->update();

        //pour la vue
        if (is_null($materiel->numImmat))
            $select_mat = $materiel->codeProduit;
        else
            $select_mat = $materiel->numImmat;
        $listExp = $materiel->exploitations()->orderBy('date_exploit','desc')->get();
        $idMat = $request->idMat;
        //$dd = $request->select_dd;
        return view('pagesGermac.Exploitation.listeExpMat',compact('listExp','select_mat','idMat','dd','materiel'));

    }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show($id)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit($id)
    {
        $exploitation = new Exploitation();
        $dd = new Demandeur();

        $exp = $exploitation->where('id',$id)->first();

        $materiel = $exp->materiel()->first();

        $idMat = $materiel->id;

        $demandeur = $exp->demandeur()->first();

        $listExp = $materiel->exploitations()->get();
        $listdd = $dd->all();

        //pour la vue
        if (is_null($materiel->numImmat))
            $select_mat = $materiel->codeProduit;
        else
            $select_mat = $materiel->numImmat;


        //dd($id,$materiel,$listdd,$demandeur,$select_mat);
       return view('pagesGermac.Exploitation.editExp',compact('id','select_mat','exp','listdd','demandeur'));


    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request, $id)
    {
        $exploitation = new Exploitation();
        $mat = new Materiel();
        $exp = $exploitation->where('id',$id)->first();//on recup l'exploitation

        $materiel = $mat->where('id',$request->idMat)->first();// le matériel qui a cette expl

            $exp->motif_exploit = $request->motif_exploit;
            $exp->date_exploit = $request->date_exploit;
            $exp->qtite_ravitaillement = $request->qtite_ravitaillement;
            $exp->releve_tableau = $request->releve_tableau;
            $exp->motif_exploit = $request->motif_exploit;
            $exp->demandeur_id = $request->select_dd;
            $exp->materiel_id = $request->idMat;
        $exp->update();

        $listExp = $materiel->exploitations()->orderBy('date_exploit','desc')->get();// la liste de ses exp
        //phase de maj de la val km ou horo du matériel concerné
        $maxReleve = $listExp->max('releve_tableau');

        if ($materiel->idgrpe == 1 ){
            $materiel->kilometrage = $maxReleve;
        }elseif($materiel->idgrpe == 2 )
            $materiel->horometre = $maxReleve;
        $materiel->update();//maj du km ou horo du matos

        //pour la vue
        if (is_null($materiel->numImmat))
            $select_mat = $materiel->codeProduit;
        else
            $select_mat = $materiel->numImmat;
        $idMat = $request->idMat;


        Flashy::success('Modification réalisée avec succès !!!');
        return redirect()->
        route('Exploitations.indexMat',[
            'listExp' => $listExp,
            'select_mat' => $select_mat,
            'idMat' => $idMat,
            'materiel' => $materiel
        ]);

    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id)
    {
        $exploitation = new Exploitation();
        $exp = $exploitation->where('id',$id)->first();
        $materiel = $exp->materiel()->first();

        //pour la vue
        if (is_null($materiel->numImmat))            // pour mettre le num du matos
            $select_mat = $materiel->codeProduit;
        else
            $select_mat = $materiel->numImmat;
       $idMat = $materiel->id;

        $exp->delete();
        $listExp = $materiel->exploitations()->get();//liste des exp

        //phase de maj de la val km ou horo du matériel concerné ** a réécrire sous forme de méthode
        $maxReleve = $listExp->max('releve_tableau');

        if ($materiel->idgrpe == 1 ){
            $materiel->kilometrage = $maxReleve;
        }elseif($materiel->idgrpe == 2 )
            $materiel->horometre = $maxReleve;
        $materiel->update();//maj du km ou horo du matos **

        Flashy::success('Suppression réalisée avec succès !!!');
       return redirect()->
       route('Exploitations.indexMat',[
            'listExp' => $listExp,
            'select_mat' => $select_mat,
            'idMat' => $idMat,
            'materiel' => $materiel
        ]);
    }
}
